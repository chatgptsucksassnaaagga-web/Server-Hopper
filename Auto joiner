-- =====================================
-- Krypth BOT (SERVER HOP + RELAY SENDER)
-- =====================================

repeat task.wait() until game:IsLoaded()

-- ===== SERVICES =====
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Player = Players.LocalPlayer
local PlaceId = game.PlaceId

-- ===== HTTP =====
local request =
    (syn and syn.request) or
    (http and http.request) or
    (fluxus and fluxus.request) or
    (krnl and krnl.request) or
    (electron and electron.request)

if type(request) ~= "function" then
    warn("HTTP unsupported")
    return
end

-- ===== CONFIG =====
local RELAY_SUBMIT = "https://operational-wheel-frames-editorials.trycloudflare.com/submit"

local HOP_DELAY = 6
local SCAN_DELAY = 5
local MAX_PAGES = 6
local MIN_MPS = 1e6

-- ===== STATE =====
local visited = {}
local hopping = false
local lastSubmit = 0

-- ===== UTILS =====
local multipliers = {
    K = 1e3,
    M = 1e6,
    B = 1e9,
    T = 1e12,
    Q = 1e15
}

local function parseMoney(text)
    if not text then return 0 end
    text = tostring(text):gsub("%$",""):gsub("/s",""):gsub("%s+","")
    local num, unit = text:match("([%d%.]+)(%a?)")
    return (tonumber(num) or 0) * (multipliers[unit] or 1)
end

-- ===== BRAINROT SCAN =====
local function scanBrainrots()
    local best = nil
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end

    for _,plot in ipairs(plots:GetChildren()) do
        for _,obj in ipairs(plot:GetDescendants()) do
            if obj.Name == "AnimalOverhead" then
                local gen = obj:FindFirstChild("Generation")
                local disp = obj:FindFirstChild("DisplayName")
                local mps = parseMoney(gen and (gen.Text or gen.Value))

                if mps >= MIN_MPS then
                    if not best or mps > best.MPS then
                        best = {
                            Name = disp and (disp.Text or disp.Value) or "Unknown",
                            MPS = mps
                        }
                    end
                end
            end
        end
    end

    return best
end

-- ===== RELAY SUBMIT =====
local function submit(best)
    if not best then return end
    if os.clock() - lastSubmit < 5 then return end
    lastSubmit = os.clock()

    task.spawn(function()
        pcall(function()
            request({
                Url = RELAY_SUBMIT,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = HttpService:JSONEncode({
                    brainrot = best.Name,
                    mps = best.MPS,
                    placeId = PlaceId,
                    jobId = game.JobId,
                    players = #Players:GetPlayers(),
                    maxPlayers = Players.MaxPlayers
                })
            })
            print("[BOT] SENT:", best.Name, best.MPS)
        end)
    end)
end

-- ===== SERVER HOP =====
local function getServers(cursor)
    local url =
        "https://games.roblox.com/v1/games/" ..
        PlaceId ..
        "/servers/Public?sortOrder=Desc&limit=100" ..
        (cursor and "&cursor="..cursor or "")

    local res = request({ Url = url, Method = "GET" })
    if not res or not res.Body then return end
    return HttpService:JSONDecode(res.Body)
end

local function hop()
    if hopping then return end
    hopping = true

    local cursor = nil

    for _ = 1, MAX_PAGES do
        local data = getServers(cursor)
        if not data or not data.data then break end

        for _,s in ipairs(data.data) do
            if s.playing < s.maxPlayers and not visited[s.id] then
                visited[s.id] = true
                TeleportService:TeleportToPlaceInstance(PlaceId, s.id, Player)
                return
            end
        end

        cursor = data.nextPageCursor
        if not cursor then break end
    end

    hopping = false
end

-- ===== MAIN LOOP =====
task.spawn(function()
    while task.wait(SCAN_DELAY) do
        local best = scanBrainrots()
        if best then
            submit(best)
        end
    end
end)

task.spawn(function()
    while task.wait(HOP_DELAY) do
        hop()
    end
end)
