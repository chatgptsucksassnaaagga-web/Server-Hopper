print("====================")
print("Krypth Notifier")
print("====================")

local KRYPT_H_TITLE = "Krypth the best AJ"

-- Webhook URLs for different MPS ranges
local WEBHOOK_1M_10M = "https://discord.com/api/webhooks/1449060869807018067/aoX36ml0daetyxDffQ72JF3Xg-hZ_iCAH-bjdBwB4c7Vd28KxQA44tGTYIlBa87pKJD5"
local WEBHOOK_10M_100M = "https://discord.com/api/webhooks/1449537390493433936/4QnFTdbekAq9lPnk-gHeB8OzXEsDxCOlqiAeSc3lO8ZlwLyWYZ_KIWSbBbWpEQIv_TkC"
local WEBHOOK_100M_INF = "https://discord.com/api/webhooks/1449537664997920889/zhV1rBRLRngGNXiwjX5VmzAiA-4DrpLyqjbSmBhV4rpzP2lUh030IdgGZQBcgT09fvHv"
local WEBHOOK_HIGHLIGHTS = "https://discord.com/api/webhooks/1449599347099566111/xQfLqvjxYfJ0PRxwFx1_bULun8C8cSMTOQi3Y4WHiX0RwC8HxYHEl6OG0POCPk6g24Yj"

-- Relay URL
local RELAY_URL = "https://sunglasses-camping-onion-kills.trycloudflare.com/submit"  -- Replace with your actual relay URL

local request = (syn and syn.request) or (http and http.request) or (fluxus and fluxus.request) or (krnl and krnl.request) or (electron and electron.request) or request
if not request then return end

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")

local multipliers = {K=1e3, M=1e6, B=1e9, T=1e12, Q=1e15}

local MIN_PLAYERS = 2
local MAX_PLAYERS = 7
local COOLDOWN = 6
local SEND_DELAY = 2

local hopping = false
local sending = false
local visitedServers = {}
local PlaceId = game.PlaceId

local webhookQueue = {}

-- Function to make an HTTP GET request
local function httpGet(url)
    local ok, res = pcall(function() return game:HttpGet(url) end)
    if ok then return res end
    local r = request({Url=url, Method="GET"})
    return r and r.Body or nil
end

-- Function to format numbers with commas
local function formatNumber(n)
    n = math.floor(n)
    local s = tostring(n)
    local f = s:reverse():gsub("(%d%d%d)", "%1,"):reverse()
    if f:sub(1,1) == "," then f = f:sub(2) end
    return f
end

-- Function to parse money strings into numbers
local function parseMoney(str)
    if not str then return 0 end
    str = tostring(str):gsub("%$",""):gsub("/s",""):gsub("Generation",""):gsub("%s+","")
    local number, unit = str:match("([%d%.]+)(%a?)")
    local n = tonumber(number) or 0
    return n * (multipliers[unit] or 1)
end

-- Function to queue a webhook request
local function queueWebhook(url, embed, priority)
    table.insert(webhookQueue, {url=url, embed=embed, priority=priority or 0})
    table.sort(webhookQueue, function(a,b) return a.priority > b.priority end)
end

-- Function to process the webhook queue
local function processQueue()
    if sending then return end
    sending = true
    while #webhookQueue > 0 do
        local item = table.remove(webhookQueue, 1)
        local payload = HttpService:JSONEncode({username=KRYPT_H_TITLE, embeds={item.embed}})
        pcall(function()
            request({Url=item.url, Method="POST", Headers={["Content-Type"]="application/json"}, Body=payload})
        end)
        task.wait(SEND_DELAY)
    end
    sending = false
end

-- Function to get all brainrots (players with high MPS)
local function getAllBrainrots()
    local scanned = {}
    local list = {}
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return list end
    for _,plot in ipairs(plots:GetChildren()) do
        for _,obj in ipairs(plot:GetDescendants()) do
            if obj.Name == "AnimalOverhead" then
                local bb = obj.Parent
                if bb then
                    local key = bb:GetFullName()
                    if not scanned[key] then
                        scanned[key] = true
                        local d = obj:FindFirstChild("DisplayName")
                        local g = obj:FindFirstChild("Generation")
                        local name = d and (d.Text or d.Value) or "Unknown"
                        local gen = g and (g.Text or g.Value) or "0"
                        local mps = parseMoney(gen)
                        if mps >= 1e6 then
                            table.insert(list,{Name=name,MPS=mps})
                        end
                    end
                end
            end
        end
    end
    table.sort(list,function(a,b) return a.MPS>b.MPS end)
    return list
end

-- Function to build the main embed for the brainrot leaderboard
local function buildMainEmbed(brainrots)
    local lines = {}
    for i,b in ipairs(brainrots) do
        local icon = (i==1 and "ðŸ‘‘") or (i==2 and "ðŸ¥ˆ") or (i==3 and "ðŸ¥‰") or "ðŸ’Ž"
        table.insert(lines, icon.." "..b.Name.." â€” $"..formatNumber(b.MPS).."/s")
    end
    local best = brainrots[1]
    local link = "https://chillihub1.github.io/chillihub-joiner/?placeId="..game.PlaceId.."&gameInstanceId="..game.JobId
    return {
        title="1x "..best.Name.." ($"..formatNumber(best.MPS).."/s)",
        color=0x2B2D31,
        fields={
            {name="ðŸ§© Pet",value="```"..best.Name.." â€” $"..formatNumber(best.MPS).."/s```"},
            {name="ðŸ†” Server ID",value="```"..game.JobId.."```"},
            {name="ðŸ“œ Join Script",value="```lua\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance("..game.PlaceId..", \""..game.JobId.."\", game.Players.LocalPlayer)\n```"},
            {name="ðŸ”— Join Link",value="[Join Server]("..link..")"},
            {name="ðŸ‘¥ Players",value="```"..#Players:GetPlayers().."/"..Players.MaxPlayers.."```"},
            {name="ðŸ§± Brainrots",value="```"..table.concat(lines,"\n").."```"}
        },
        timestamp=os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
end

-- Function to build the highlight embed (secondary leaderboard)
local function buildHighlightEmbed(brainrots)
    local best = brainrots[1]
    local rest = {}
    for i=2,#brainrots do
        table.insert(rest, brainrots[i].Name.." â€” $"..formatNumber(brainrots[i].MPS).."/s")
    end
    return {
        title="Krypth | HighLights",
        color=0xFFD700,
        fields={
            {name="ðŸ’° Top Brainrot",value="```"..best.Name.." â€” $"..formatNumber(best.MPS).."/s```"},
            {name="ðŸ§± Other Brainrots",value="```"..table.concat(rest,"\n").."```"}
        },
        timestamp=os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
end

-- Function to route brainrots to the appropriate webhooks
local function routeBrainrots(brainrots)
    if #brainrots == 0 then return end
    local best = brainrots[1]
    local main = buildMainEmbed(brainrots)
    local hi = buildHighlightEmbed(brainrots)
    
    -- Send to the appropriate webhook based on MPS
    if best.MPS < 1e7 then
        queueWebhook(WEBHOOK_1M_10M, main, best.MPS)
    elseif best.MPS < 1e8 then
        queueWebhook(WEBHOOK_10M_100M, main, best.MPS)
        queueWebhook(WEBHOOK_HIGHLIGHTS, hi, best.MPS)
    else
        queueWebhook(WEBHOOK_100M_INF, main, best.MPS)
        queueWebhook(WEBHOOK_HIGHLIGHTS, hi, best.MPS)
    end
    -- Send the webhook requests
    processQueue()
    
    -- Send data to the relay URL
    local success, errorMsg = pcall(function()
        local data = {
            brainrots = brainrots,
            serverId = game.JobId,
            placeId = game.PlaceId,
        }
        local payload = HttpService:JSONEncode(data)
        local response = request({Url=RELAY_URL, Method="POST", Body=payload, Headers={["Content-Type"]="application/json"}})
        
        -- Check for response status and log errors
        if response and response.StatusCode ~= 200 then
            warn("Failed to send data to relay URL. Status: "..response.StatusCode)
        end
    end)

    -- Error handling for the relay POST request
    if not success then
        warn("Error sending to relay URL: "..errorMsg)
    end
end

-- Function to get available servers from the API
local function GetServers(cursor)
    local url = "https://games.roblox.com/v1/games/"..PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
    if cursor then url = url.."&cursor="..cursor end
    local body = httpGet(url)
    if not body then return nil end
    local data = HttpService:JSONDecode(body)
    if not data or type(data.data) ~= "table" then
        data = {data={}}
    end
    return data
end

-- Function to find a good server to teleport to
local function FindGoodServer()
    local cursor
    while true do
        local data = GetServers(cursor)
        if not data then break end
        for _,server in ipairs(data.data) do
            if server.playing >= MIN_PLAYERS and server.playing <= MAX_PLAYERS and server.id ~= game.JobId and not visitedServers[server.id] then
                visitedServers[server.id] = true
                return server.id
            end
        end
        cursor = data.nextPageCursor
        if not cursor then break end
    end
    visitedServers = {}
end

-- Main loop for sending notifications and hopping servers
task.spawn(function()
    while true do
        task.wait(COOLDOWN)
        if not hopping then
            hopping = true
            local brainrots = getAllBrainrots()
            routeBrainrots(brainrots)
            local id = FindGoodServer()
            if id then
                pcall(function()
                    TeleportService:TeleportToPlaceInstance(PlaceId, id, Player)
                end)
            end
            hopping = false
        end
    end
end)
