print("====================")
print("Krypth Unified Notifier")
print("====================")

-- ===== CONFIG =====
local RELAY_SUBMIT = "https://sunglasses-camping-onion-kills.trycloudflare.com/submit" -- Ensure this is set correctly
local KRYPT_H_TITLE = "Krypth the best AJ"

local WEBHOOK_1M_10M = "https://discord.com/api/webhooks/1449060869807018067/aoX36ml0daetyxDffQ72JF3Xg-hZ_iCAH-bjdBwB4c7Vd28KxQA44tGTYIlBa87pKJD5"
local WEBHOOK_10M_100M = "https://discord.com/api/webhooks/1449537390493433936/4QnFTdbekAq9lPnk-gHeB8OzXEsDxCOlqiAeSc3lO8ZlwLyWYZ_KIWSbBbWpEQIv_TkC"
local WEBHOOK_100M_INF = "https://discord.com/api/webhooks/1449537664997920889/zhV1rBRLRngGNXiwjX5VmzAiA-4DrpLyqjbSmBhV4rpzP2lUh030IdgGZQBcgT09fvHv"
local WEBHOOK_HIGHLIGHTS = "https://discord.com/api/webhooks/1449599347099566111/xQfLqvjxYf0PRxwFx1_bULun8C8cSMTOQi3Y4WHiX0RwC8HxYHEl6OG0POCPk6g24Yj"

local MIN_PLAYERS = 2
local MAX_PLAYERS = 7
local COOLDOWN = 6
local SEND_DELAY = 2
local MAX_SERVER_PAGES = 5
local SCAN_CACHE_TIME = 5

-- ===== SERVICES =====
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Player = Players.LocalPlayer
local PlaceId = game.PlaceId

-- ===== REQUEST =====
local request = (syn and syn.request) or (http and http.request) or (fluxus and fluxus.request) or (krnl and krnl.request) or (electron and electron.request)

if type(request) ~= "function" then return end

-- ===== STATE =====
local multipliers = {K=1e3,M=1e6,B=1e9,T=1e12,Q=1e15}
local visitedServers = {}
local hopping = false
local sending = false
local webhookQueue = {}

local lastScan = 0
local cachedBrainrots = {}

-- ===== UTILS =====
local function parseMoney(str)
    if not str then return 0 end
    str = tostring(str):gsub("%$",""):gsub("/s",""):gsub("Generation",""):gsub("%s+","")
    local num,unit = str:match("([%d%.]+)(%a?)")
    return (tonumber(num) or 0) * (multipliers[unit] or 1)
end

local function formatNumber(n)
    local s = tostring(math.floor(n))
    return s:reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,","")
end

-- ===== BRAINROT SCAN =====
local function scanBrainrots()
    local scanned, list = {}, {}
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return list end

    for _,plot in ipairs(plots:GetChildren()) do
        task.wait()
        for _,obj in ipairs(plot:GetDescendants()) do
            if obj.Name == "AnimalOverhead" then
                local bb = obj.Parent
                if bb and not scanned[bb] then
                    scanned[bb] = true
                    local d = obj:FindFirstChild("DisplayName")
                    local g = obj:FindFirstChild("Generation")
                    local mps = parseMoney(g and (g.Text or g.Value))
                    if mps > 0 then
                        table.insert(list,{
                            Name = d and (d.Text or d.Value) or "Unknown",
                            MPS = mps
                        })
                    end
                end
            end
        end
    end

    table.sort(list,function(a,b) return a.MPS>b.MPS end)
    return list
end

local function getAllBrainrots()
    if os.clock() - lastScan < SCAN_CACHE_TIME then
        return cachedBrainrots
    end
    lastScan = os.clock()
    cachedBrainrots = scanBrainrots()
    return cachedBrainrots
end

-- ===== WEBHOOK QUEUE =====
local function queueWebhook(url, embed, prio)
    table.insert(webhookQueue,{url=url,embed=embed,prio=prio or 0})
    table.sort(webhookQueue,function(a,b) return a.prio>b.prio end)
end

local function processQueue()
    if sending then return end
    sending = true

    while #webhookQueue > 0 do
        local w = table.remove(webhookQueue,1)
        pcall(function()
            request({
                Url = w.url,
                Method = "POST",
                Headers = {["Content-Type"]="application/json"},
                Body = HttpService:JSONEncode({
                    username = KRYPT_H_TITLE,
                    embeds = {w.embed}
                })
            })
        end)
        task.wait(SEND_DELAY)
    end

    sending = false
end

-- ===== EMBEDS =====
local function buildMainEmbed(brainrots)
    local lines = {}
    for i,b in ipairs(brainrots) do
        local icon = (i==1 and "ðŸ‘‘") or (i==2 and "ðŸ¥ˆ") or (i==3 and "ðŸ¥‰") or "ðŸ’Ž"
        table.insert(lines, icon.." "..b.Name.." â€” $"..formatNumber(b.MPS).."/s")
    end

    local best = brainrots[1]
    local link = "https://chillihub1.github.io/chillihub-joiner/?placeId="..PlaceId.."&gameInstanceId="..game.JobId

    return {
        title = "1x "..best.Name.." ($"..formatNumber(best.MPS).."/s)",
        color = 0x2B2D31,
        fields = {
            {name="ðŸ§© Pet",value="```"..best.Name.." â€” $"..formatNumber(best.MPS).."/s```"},
            {name="ðŸ†” Server ID",value="```"..game.JobId.."```"},
            {name="ðŸ“œ Join Script",value="```lua\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance("..PlaceId..", \""..game.JobId.."\", game.Players.LocalPlayer)\n```"},
            {name="ðŸ”— Join Link",value="[Join Server]("..link..")"},
            {name="ðŸ‘¥ Players",value="```"..#Players:GetPlayers().."/"..Players.MaxPlayers.."```"},
            {name="ðŸ§± Brainrots",value="```"..table.concat(lines,"\n").."```"}
        },
        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
end

local function buildHighlightEmbed(best)
    return {
        title = "Krypth | Highlights",
        color = 0xFFD700,
        fields = {
            {name="ðŸ’° Top", value="```"..best.Name.." â€” $"..formatNumber(best.MPS).."/s```"}
        },
        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
end

local function buildEmbeds(brainrots)
    local best = brainrots[1]
    if not best then return end

    local main = buildMainEmbed(brainrots)
    local highlight = buildHighlightEmbed(best)

    if best.MPS < 1e7 then
        queueWebhook(WEBHOOK_1M_10M, main, best.MPS)
    elseif best.MPS < 1e8 then
        queueWebhook(WEBHOOK_10M_100M, main, best.MPS)
        queueWebhook(WEBHOOK_HIGHLIGHTS, highlight, best.MPS)
    else
        queueWebhook(WEBHOOK_100M_INF, main, best.MPS)
        queueWebhook(WEBHOOK_HIGHLIGHTS, highlight, best.MPS)
    end
end

-- ===== MAIN LOOP =====
task.spawn(function()
    while task.wait(COOLDOWN) do
        if hopping then continue end
        hopping = true

        local brainrots = getAllBrainrots()
        if brainrots[1] then
            buildEmbeds(brainrots)
            task.spawn(processQueue)
        end

        hopping = false
    end
end)
