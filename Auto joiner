print("====================")
print("Krypth Notifier")
print("====================")

local RELAY_SUBMIT = "https://venture-round-blake-commercial.trycloudflare.com"

local request = (syn and syn.request) or (http and http.request) or (fluxus and fluxus.request) or (krnl and krnl.request) or (electron and electron.request) or request
if not request then return end

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")

local multipliers = {K=1e3,M=1e6,B=1e9,T=1e12,Q=1e15}

local MIN_PLAYERS = 2
local MAX_PLAYERS = 7
local COOLDOWN = 6

local hopping = false
local visitedServers = {}
local PlaceId = game.PlaceId

local function httpGet(url)
    local ok, res = pcall(function() return game:HttpGet(url) end)
    if ok then return res end
    local r = request({Url=url, Method="GET"})
    return r and r.Body or nil
end

local function parseMoney(str)
    if not str then return 0 end
    str = tostring(str):gsub("%$",""):gsub("/s",""):gsub("Generation",""):gsub("%s+","")
    local number,unit = str:match("([%d%.]+)(%a?)")
    local n = tonumber(number) or 0
    return n * (multipliers[unit] or 1)
end

local function getAllBrainrots()
    local scanned = {}
    local list = {}
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return list end
    for _,plot in ipairs(plots:GetChildren()) do
        for _,obj in ipairs(plot:GetDescendants()) do
            if obj.Name == "AnimalOverhead" then
                local bb = obj.Parent
                if bb then
                    local key = bb:GetFullName()
                    if not scanned[key] then
                        scanned[key] = true
                        local d = obj:FindFirstChild("DisplayName")
                        local g = obj:FindFirstChild("Generation")
                        local name = d and (d.Text or d.Value) or "Unknown"
                        local gen = g and (g.Text or g.Value) or "0"
                        local mps = parseMoney(gen)
                        if mps > 0 then
                            table.insert(list,{Name=name,MPS=mps})
                        end
                    end
                end
            end
        end
    end
    table.sort(list,function(a,b) return a.MPS>b.MPS end)
    return list
end

local function sendToRelay(brainrot)
    local payload = {
        brainrot = brainrot.Name,
        money = brainrot.MPS,
        mps = brainrot.MPS,
        placeId = PlaceId,
        jobId = game.JobId,
        players = #Players:GetPlayers(),
        maxPlayers = Players.MaxPlayers
    }
    pcall(function()
        request({
            Url = RELAY_SUBMIT,
            Method = "POST",
            Headers = {["Content-Type"]="application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)
end

local function GetServers(cursor)
    local url = "https://games.roblox.com/v1/games/"..PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
    if cursor then url = url.."&cursor="..cursor end
    local body = httpGet(url)
    if not body then return nil end
    local data = HttpService:JSONDecode(body)
    if not data or type(data.data) ~= "table" then
        data = {data={}}
    end
    return data
end

local function FindGoodServer()
    local cursor
    while true do
        local data = GetServers(cursor)
        if not data then break end
        for _,server in ipairs(data.data) do
            if server.playing >= MIN_PLAYERS and server.playing <= MAX_PLAYERS and server.id ~= game.JobId and not visitedServers[server.id] then
                visitedServers[server.id] = true
                return server.id
            end
        end
        cursor = data.nextPageCursor
        if not cursor then break end
    end
    visitedServers = {}
end

task.spawn(function()
    while true do
        task.wait(COOLDOWN)
        if not hopping then
            hopping = true
            local brainrots = getAllBrainrots()
            if brainrots[1] then
                sendToRelay(brainrots[1])
            end
            local id = FindGoodServer()
            if id then
                pcall(function()
                    TeleportService:TeleportToPlaceInstance(PlaceId, id, Player)
                end)
            end
            hopping = false
        end
    end
end)

